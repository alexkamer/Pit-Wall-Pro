---
import Layout from '../layouts/Layout.astro';
---

<Layout title="F1 Standings 2024">
  <div class="max-w-7xl mx-auto px-4 py-12">
    <h1 class="text-4xl font-bold mb-8">2024 Championship Standings</h1>

    <div id="loading" class="text-center py-12">
      <p class="text-xl text-gray-400">Loading standings data...</p>
    </div>

    <div id="content" class="hidden">
      <!-- Driver Standings -->
      <div class="bg-gray-900/50 border border-gray-800 rounded-lg p-6 mb-8">
        <h2 class="text-2xl font-bold mb-4">Driver Standings</h2>
        <div class="overflow-x-auto">
          <table id="driverTable" class="w-full text-sm border-collapse">
            <thead class="bg-gray-800/50 border-b border-gray-700">
              <tr>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">Pos</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">Driver</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">Team</th>
                <th class="px-3 py-3 text-right text-xs font-medium text-gray-400 uppercase">Points</th>
              </tr>
            </thead>
            <tbody id="driverTableBody" class="divide-y divide-gray-800">
            </tbody>
          </table>
        </div>
      </div>

      <!-- Constructor Standings -->
      <div class="bg-gray-900/50 border border-gray-800 rounded-lg p-6">
        <h2 class="text-2xl font-bold mb-4">Constructor Standings</h2>
        <div class="overflow-x-auto">
          <table id="constructorTable" class="w-full text-sm border-collapse">
            <thead class="bg-gray-800/50 border-b border-gray-700">
              <tr>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">Pos</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">Team</th>
                <th class="px-3 py-3 text-right text-xs font-medium text-gray-400 uppercase">Points</th>
              </tr>
            </thead>
            <tbody id="constructorTableBody" class="divide-y divide-gray-800">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="error" class="hidden">
      <div class="bg-red-900/20 border border-red-800 rounded-lg p-6">
        <h2 class="text-2xl font-bold text-red-400 mb-2">Error Loading Data</h2>
        <p id="errorMessage" class="text-gray-300"></p>
      </div>
    </div>
  </div>
</Layout>

<script>
  const API_BASE_URL = 'http://localhost:8000';
  const YEAR = 2024;

  async function fetchAPI(endpoint) {
    const response = await fetch(`${API_BASE_URL}${endpoint}`);
    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
    return response.json();
  }

  async function loadStandings() {
    try {
      // Fetch driver standings
      const driverStandings = await fetchAPI(`/espn/standings/${YEAR}?type=driver`);

      // Fetch constructor standings
      const constructorStandings = await fetchAPI(`/espn/standings/${YEAR}?type=constructor`);

      // Populate driver table
      const driverTableBody = document.getElementById('driverTableBody');
      driverStandings.standings.forEach((standing, index) => {
        const points = standing.records[0]?.stats?.find(s => s.name === 'championshipPts')?.value || 0;

        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-800/30 transition-colors';
        row.innerHTML = `
          <td class="px-3 py-3 whitespace-nowrap font-bold">${index + 1}</td>
          <td class="px-3 py-3 whitespace-nowrap">${standing.athlete.displayName || 'Unknown'}</td>
          <td class="px-3 py-3 whitespace-nowrap text-gray-400">${standing.athlete.team || 'Unknown'}</td>
          <td class="px-3 py-3 whitespace-nowrap text-right font-bold">${points}</td>
        `;
        driverTableBody.appendChild(row);
      });

      // Populate constructor table
      const constructorTableBody = document.getElementById('constructorTableBody');

      for (const [index, standing] of constructorStandings.standings.entries()) {
        const points = standing.records[0]?.stats?.find(s => s.name === 'points')?.value || 0;

        // Fetch team name
        let teamName = 'Unknown Team';
        try {
          const manufacturerRef = standing.manufacturer?.$ref;
          if (manufacturerRef) {
            const manufacturer = await fetch(manufacturerRef).then(r => r.json());
            teamName = manufacturer.displayName || manufacturer.name || teamName;
          }
        } catch (e) {
          console.error('Error fetching team name:', e);
        }

        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-800/30 transition-colors';
        row.innerHTML = `
          <td class="px-3 py-3 whitespace-nowrap font-bold">${index + 1}</td>
          <td class="px-3 py-3 whitespace-nowrap">${teamName}</td>
          <td class="px-3 py-3 whitespace-nowrap text-right font-bold">${points}</td>
        `;
        constructorTableBody.appendChild(row);
      }

      // Hide loading, show content
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');

    } catch (error) {
      console.error('Error loading standings:', error);
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('errorMessage').textContent = error.message;
    }
  }

  // Load data when page loads
  document.addEventListener('DOMContentLoaded', loadStandings);
</script>
</Layout>
