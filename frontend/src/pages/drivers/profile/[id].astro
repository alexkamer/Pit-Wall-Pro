---
import Layout from '../../../layouts/Layout.astro';
import { getDriverProfile } from '../../../lib/api';

export const prerender = false;

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/drivers');
}

let profileData: any = null;
let error: string | null = null;

try {
  profileData = await getDriverProfile(id);
} catch (e) {
  error = e instanceof Error ? e.message : 'Failed to load driver profile';
  console.error(`Error fetching driver profile for ${id}:`, e);
}

const driver = profileData?.driver;
const seasons = profileData?.seasons || [];
const raceResults = profileData?.raceResults || [];

// Country to flag emoji mapping
const getNationalityFlag = (nationality: string): string => {
  if (!nationality) return 'üèÅ';

  const countryToCode: Record<string, string> = {
    'Netherlands': 'NL', 'Britain': 'GB', 'Monaco': 'MC', 'Australia': 'AU',
    'Spain': 'ES', 'Mexico': 'MX', 'Canada': 'CA', 'Germany': 'DE',
    'France': 'FR', 'Finland': 'FI', 'Denmark': 'DK', 'China': 'CN',
    'Japan': 'JP', 'Thailand': 'TH', 'USA': 'US', 'United States': 'US',
    'Italy': 'IT', 'Austria': 'AT', 'Belgium': 'BE', 'Switzerland': 'CH',
    'Brazil': 'BR', 'Argentina': 'AR', 'Colombia': 'CO', 'Venezuela': 'VE',
    'Sweden': 'SE', 'Poland': 'PL', 'Russia': 'RU', 'New Zealand': 'NZ',
    'South Africa': 'ZA', 'Portugal': 'PT', 'Ireland': 'IE', 'India': 'IN',
    'Malaysia': 'MY',
  };

  const code = countryToCode[nationality];
  if (!code) return 'üèÅ';

  return String.fromCodePoint(
    ...code.split('').map(char => 127397 + char.charCodeAt(0))
  );
};

const formatDate = (dateStr: string) => {
  if (!dateStr) return 'Unknown';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
};

const calculateAge = (birthDate: string) => {
  if (!birthDate) return null;
  const today = new Date();
  const birth = new Date(birthDate);
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--;
  }
  return age;
};
---

<Layout title={driver ? `${driver.display_name} - F1 Driver Profile` : 'Driver Profile'}>
  <div class="max-w-7xl mx-auto px-4 py-8">
    {error && (
      <div class="bg-red-900/50 border border-red-700 rounded-lg p-6 mb-8">
        <h2 class="text-xl font-bold text-red-400 mb-2">Error Loading Profile</h2>
        <p class="text-red-300">{error}</p>
        <a href="/drivers" class="inline-block mt-4 text-red-400 hover:text-red-300">
          ‚Üê Back to Drivers Search
        </a>
      </div>
    )}

    {driver && (
      <div>
        <!-- Back Button -->
        <a
          href="/drivers"
          class="inline-flex items-center gap-2 text-gray-400 hover:text-white mb-6 transition-colors"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back to Drivers
        </a>

        <!-- Driver Header -->
        <div class="bg-gray-900/50 border border-gray-800 rounded-lg p-8 mb-8">
          <div class="flex flex-col md:flex-row items-center md:items-start gap-8">
            <!-- Driver Photo -->
            <div class="flex-shrink-0">
              {driver.headshot_url ? (
                <img
                  src={driver.headshot_url}
                  alt={driver.display_name}
                  class="w-48 h-48 rounded-full object-cover border-4 border-gray-700"
                  onerror="this.style.display='none'"
                />
              ) : (
                <div class="w-48 h-48 rounded-full bg-gray-800 border-4 border-gray-700 flex items-center justify-center">
                  <span class="text-8xl">üèéÔ∏è</span>
                </div>
              )}
            </div>

            <!-- Driver Info -->
            <div class="flex-1 text-center md:text-left">
              <div class="flex items-center gap-3 justify-center md:justify-start mb-4">
                <h1 class="text-5xl font-bold text-white">{driver.display_name}</h1>
                <span class="text-5xl">{getNationalityFlag(driver.nationality)}</span>
                {driver.active && (
                  <span class="bg-green-600 text-white text-sm px-3 py-1 rounded-full">
                    Active
                  </span>
                )}
              </div>

              {driver.abbreviation && (
                <p class="text-2xl text-gray-400 mb-6">{driver.abbreviation}</p>
              )}

              <!-- Basic Info Grid -->
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                {driver.nationality && (
                  <div>
                    <p class="text-sm text-gray-500">Nationality</p>
                    <p class="text-lg text-white font-medium">{driver.nationality}</p>
                  </div>
                )}
                {driver.date_of_birth && (
                  <div>
                    <p class="text-sm text-gray-500">Date of Birth</p>
                    <p class="text-lg text-white font-medium">{formatDate(driver.date_of_birth)}</p>
                    {calculateAge(driver.date_of_birth) && (
                      <p class="text-sm text-gray-400">({calculateAge(driver.date_of_birth)} years old)</p>
                    )}
                  </div>
                )}
                {driver.birth_place && (
                  <div>
                    <p class="text-sm text-gray-500">Place of Birth</p>
                    <p class="text-lg text-white font-medium">{driver.birth_place}</p>
                  </div>
                )}
                {driver.number && (
                  <div>
                    <p class="text-sm text-gray-500">Racing Number</p>
                    <p class="text-lg text-white font-medium">#{driver.number}</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>

        <!-- Career Statistics -->
        <div class="mb-8">
          <h2 class="text-3xl font-bold text-white mb-6">Career Statistics</h2>
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div class="bg-gray-900/50 border border-gray-800 rounded-lg p-6 text-center">
              <div class="text-4xl font-bold text-white mb-2">{driver.total_races || 0}</div>
              <div class="text-sm text-gray-400">Races</div>
            </div>
            <div class="bg-gray-900/50 border border-gray-800 rounded-lg p-6 text-center">
              <div class="text-4xl font-bold text-yellow-500 mb-2">{driver.wins || 0}</div>
              <div class="text-sm text-gray-400">Wins</div>
            </div>
            <div class="bg-gray-900/50 border border-gray-800 rounded-lg p-6 text-center">
              <div class="text-4xl font-bold text-orange-500 mb-2">{driver.podiums || 0}</div>
              <div class="text-sm text-gray-400">Podiums</div>
            </div>
          </div>
        </div>

        <!-- Career Performance by Year -->
        {seasons.length > 0 && (
          <div class="mb-8">
            <h2 class="text-3xl font-bold text-white mb-6">Career Performance by Year</h2>
            <div class="bg-gray-900/50 border border-gray-800 rounded-lg overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-800">
                    <tr>
                      <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Year</th>
                      <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Team</th>
                      <th class="px-6 py-4 text-center text-sm font-semibold text-gray-300">Races</th>
                      <th class="px-6 py-4 text-center text-sm font-semibold text-gray-300">Wins</th>
                      <th class="px-6 py-4 text-center text-sm font-semibold text-gray-300">Podiums</th>
                      <th class="px-6 py-4 text-center text-sm font-semibold text-gray-300">Win Rate</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-800">
                    {seasons.map((season: any) => {
                      const winRate = season.races > 0 ? ((season.wins / season.races) * 100).toFixed(1) : '0.0';
                      return (
                        <tr class="hover:bg-gray-800/50 transition-colors">
                          <td class="px-6 py-4 text-white font-medium">{season.year}</td>
                          <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                              {season.team_logo && !season.team_logo.includes('fallback') && (
                                <img
                                  src={season.team_logo}
                                  alt={season.team_name}
                                  class="h-6 object-contain"
                                  onerror="this.style.display='none'"
                                />
                              )}
                              <span class="text-gray-300">{season.team_name || 'Unknown'}</span>
                            </div>
                          </td>
                          <td class="px-6 py-4 text-center text-gray-300">{season.races}</td>
                          <td class="px-6 py-4 text-center text-yellow-500 font-semibold">{season.wins}</td>
                          <td class="px-6 py-4 text-center text-orange-500 font-semibold">{season.podiums}</td>
                          <td class="px-6 py-4 text-center text-gray-300">{winRate}%</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        <!-- Race by Race Results -->
        {raceResults.length > 0 && (() => {
          // Group races by year
          const racesByYear = {};
          raceResults.forEach((race) => {
            if (!racesByYear[race.year]) {
              racesByYear[race.year] = [];
            }
            racesByYear[race.year].push(race);
          });

          // Get all unique years, sorted descending
          const years = Object.keys(racesByYear).map(Number).sort((a, b) => b - a);

          // Get the maximum number of races in any year
          const maxRaces = Math.max(...years.map(year => racesByYear[year].length));

          // Create a map of year to season data for points and championship position
          const seasonMap = {};
          seasons.forEach((season) => {
            seasonMap[season.year] = season;
          });

          return (
            <div>
              <h2 class="text-3xl font-bold text-white mb-6">Race by Race Results</h2>
              <div class="bg-gray-900/50 border border-gray-800 rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead class="bg-gray-800">
                      <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 sticky left-0 bg-gray-800 z-10">Year</th>
                        {Array.from({length: maxRaces}, (_, i) => (
                          <th class="px-3 py-3 text-center text-xs font-semibold text-gray-300 min-w-[80px]">
                            R{i + 1}
                          </th>
                        ))}
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-300 sticky right-20 bg-gray-800 z-10 border-l border-gray-700">Points</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-300 sticky right-0 bg-gray-800 z-10 border-l border-gray-700">Pos</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800">
                      {years.map((year) => {
                        const yearRaces = racesByYear[year].sort((a, b) => a.round_number - b.round_number);
                        const seasonData = seasonMap[year] || {};
                        const totalPoints = seasonData.points || 0;
                        const championshipPos = seasonData.championship_position;

                        return (
                          <tr class="hover:bg-gray-800/50 transition-colors">
                            <td class="px-4 py-3 text-white font-medium sticky left-0 bg-gray-900/50 z-10">{year}</td>
                            {Array.from({length: maxRaces}, (_, i) => {
                              const race = yearRaces[i];
                              if (!race) {
                                return <td class="px-3 py-3 text-center text-gray-700">-</td>;
                              }

                              const position = race.position;
                              const gridPosition = race.grid_position;
                              const hasFastestLap = race.fastest_lap;

                              return (
                                <td class="px-3 py-3 text-center group relative">
                                  <div class="flex flex-col items-center gap-0.5">
                                    {position ? (
                                      <span class={`text-sm font-semibold ${
                                        position === 1 ? 'text-yellow-500' :
                                        position === 2 ? 'text-gray-300' :
                                        position === 3 ? 'text-orange-500' :
                                        position <= 10 ? 'text-gray-400' : 'text-gray-600'
                                      }`}>
                                        {position}
                                      </span>
                                    ) : (
                                      <span class="text-xs text-red-500 font-medium">DNF</span>
                                    )}
                                    <div class="flex items-center gap-1 text-xs text-gray-500">
                                      {gridPosition && <span>({gridPosition})</span>}
                                      {hasFastestLap && <span class="text-purple-400">‚óè</span>}
                                    </div>
                                  </div>
                                  {/* Tooltip */}
                                  <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-950 border border-gray-700 rounded-lg text-xs text-white whitespace-nowrap opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-opacity z-20 pointer-events-none">
                                    <div class="font-semibold mb-1">{race.event_name}</div>
                                    <div class="text-gray-400">Round {race.round_number}</div>
                                    {gridPosition && <div class="text-gray-400">Grid: P{gridPosition}</div>}
                                    {position && <div class="text-gray-400">Finish: P{position}</div>}
                                    {!position && <div class="text-red-400">Did Not Finish</div>}
                                    {hasFastestLap && <div class="text-purple-400">Fastest Lap</div>}
                                    <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-l-transparent border-r-transparent border-t-gray-700"></div>
                                  </div>
                                </td>
                              );
                            })}
                            <td class="px-4 py-3 text-center font-semibold text-white sticky right-20 bg-gray-900/50 z-10 border-l border-gray-700">{totalPoints}</td>
                            <td class={`px-4 py-3 text-center font-semibold sticky right-0 bg-gray-900/50 z-10 border-l border-gray-700 ${
                              championshipPos === 1 ? 'text-yellow-500' :
                              championshipPos === 2 ? 'text-gray-300' :
                              championshipPos === 3 ? 'text-orange-500' :
                              championshipPos && championshipPos <= 10 ? 'text-gray-400' : 'text-gray-600'
                            }`}>
                              {championshipPos || '-'}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="mt-4 flex flex-wrap gap-4 text-sm text-gray-400">
                <div>Position shown, (grid position) below</div>
                <div class="flex items-center gap-1"><span class="text-purple-400">‚óè</span> = Fastest Lap</div>
                <div><span class="text-yellow-500">1</span> = Win</div>
                <div><span class="text-orange-500">3</span> = Podium</div>
                <div><span class="text-red-500">DNF</span> = Did Not Finish</div>
              </div>
            </div>
          );
        })()}
      </div>
    )}
  </div>
</Layout>

<style>
  table {
    border-collapse: separate;
    border-spacing: 0;
  }
</style>
