---
import Layout from '../layouts/Layout.astro';
import { getDriverStandings, getDriverRaceResults, getConstructorRaceResults } from '../lib/api';

const currentYear = 2025;
const driverStandings = await getDriverStandings(currentYear);
const driverRaceResults = await getDriverRaceResults(currentYear);
const constructorRaceResults = await getConstructorRaceResults(currentYear);

// Sort by total points descending
driverRaceResults.sort((a, b) => b.totalPoints - a.totalPoints);
constructorRaceResults.sort((a, b) => b.totalPoints - a.totalPoints);

// Get unique race names and countries for table headers
const races = constructorRaceResults[0]?.raceResults.map(r => ({
  name: r.eventName,
  country: r.country
})) || [];

const driverRaces = driverRaceResults[0]?.raceResults.map(r => ({
  name: r.eventName,
  country: r.country
})) || [];

// Country to ISO code mapping for flag emojis
const countryToCode: Record<string, string> = {
  'Australia': 'AU',
  'Austria': 'AT',
  'Azerbaijan': 'AZ',
  'Bahrain': 'BH',
  'Belgium': 'BE',
  'Brazil': 'BR',
  'Canada': 'CA',
  'China': 'CN',
  'France': 'FR',
  'Germany': 'DE',
  'Hungary': 'HU',
  'Italy': 'IT',
  'Japan': 'JP',
  'Mexico': 'MX',
  'Monaco': 'MC',
  'Netherlands': 'NL',
  'Qatar': 'QA',
  'Saudi Arabia': 'SA',
  'Singapore': 'SG',
  'Spain': 'ES',
  'United Kingdom': 'GB',
  'USA': 'US',
  'United States': 'US',
  'United Arab Emirates': 'AE'
};

// Convert country name to flag emoji
const getCountryFlag = (country: string): string => {
  const code = countryToCode[country];
  if (!code) return '';

  // Convert country code to flag emoji using regional indicator symbols
  return String.fromCodePoint(
    ...code.split('').map(char => 127397 + char.charCodeAt(0))
  );
};

// Calculate cumulative standings after each race for drivers
const calculateDriverCumulativeStandings = () => {
  const numRaces = driverRaces.length;
  const standings = [];

  for (let raceIndex = 0; raceIndex < numRaces; raceIndex++) {
    const cumulativePoints = driverRaceResults.map(driver => ({
      driverKey: driver.driverAbbreviation,
      points: driver.raceResults.slice(0, raceIndex + 1).reduce((sum, race) => sum + race.points, 0)
    }));

    cumulativePoints.sort((a, b) => b.points - a.points);

    const raceStandings = {};
    let currentPosition = 1;

    for (let i = 0; i < cumulativePoints.length; i++) {
      const driver = cumulativePoints[i];

      if (i > 0 && driver.points === cumulativePoints[i - 1].points) {
        const prevPosition = raceStandings[cumulativePoints[i - 1].driverKey];
        const basePosition = prevPosition.toString().replace('T', '');
        raceStandings[driver.driverKey] = `T${basePosition}`;
        raceStandings[cumulativePoints[i - 1].driverKey] = `T${basePosition}`;
      } else {
        raceStandings[driver.driverKey] = currentPosition;
        currentPosition = i + 2;
      }
    }

    standings.push(raceStandings);
  }

  return standings;
};

// Calculate cumulative standings after each race for constructors
const calculateConstructorCumulativeStandings = () => {
  const numRaces = races.length;
  const standings = [];

  for (let raceIndex = 0; raceIndex < numRaces; raceIndex++) {
    const cumulativePoints = constructorRaceResults.map(team => ({
      teamName: team.teamName,
      points: team.raceResults.slice(0, raceIndex + 1).reduce((sum, race) => sum + race.points, 0)
    }));

    cumulativePoints.sort((a, b) => b.points - a.points);

    const raceStandings = {};
    let currentPosition = 1;

    for (let i = 0; i < cumulativePoints.length; i++) {
      const team = cumulativePoints[i];

      if (i > 0 && team.points === cumulativePoints[i - 1].points) {
        const prevPosition = raceStandings[cumulativePoints[i - 1].teamName];
        const basePosition = prevPosition.toString().replace('T', '');
        raceStandings[team.teamName] = `T${basePosition}`;
        raceStandings[cumulativePoints[i - 1].teamName] = `T${basePosition}`;
      } else {
        raceStandings[team.teamName] = currentPosition;
        currentPosition = i + 2;
      }
    }

    standings.push(raceStandings);
  }

  return standings;
};

const driverCumulativeStandings = calculateDriverCumulativeStandings();
const constructorCumulativeStandings = calculateConstructorCumulativeStandings();
---

<Layout title={`F1 Standings ${currentYear}`}>
  <div class="max-w-7xl mx-auto px-4 py-12">
    <h1 class="text-4xl font-bold mb-8">{currentYear} Championship Standings</h1>

    <div class="bg-gray-900/50 border border-gray-800 rounded-lg p-6 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold">Driver Standings - Points by Race</h2>
        <label class="flex items-center gap-3 cursor-pointer">
          <span class="text-sm text-gray-400">Show Positions</span>
          <input
            type="checkbox"
            id="showDriverPositions"
            class="w-5 h-5 rounded bg-gray-800 border-gray-700 text-blue-600 focus:ring-blue-500 focus:ring-2"
          />
        </label>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm border-collapse">
          <thead class="bg-gray-800/50 border-b border-gray-700">
            <tr>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase sticky left-0 bg-gray-800 z-10 w-20">Pos</th>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase sticky left-[3.06rem] bg-gray-800 z-10 min-w-48">Driver</th>
              {driverRaces.map((race) => (
                <th class="px-3 py-3 text-center text-xs font-medium text-gray-400 uppercase whitespace-nowrap">
                  <div class="flex flex-col items-center gap-1">
                    <span class="text-2xl">{getCountryFlag(race.country)}</span>
                    <span>{race.name}</span>
                  </div>
                </th>
              ))}
              <th class="px-3 py-3 text-right text-xs font-medium text-gray-400 uppercase sticky right-0 bg-gray-800">Total</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-800">
            {driverRaceResults.map((driver, index) => (
              <tr class="hover:bg-gray-800/30 transition-colors">
                <td class="px-3 py-3 whitespace-nowrap sticky left-0 bg-gray-900 z-10 w-20">
                  <div class="font-bold">{index + 1}</div>
                </td>
                <td class="px-3 py-3 whitespace-nowrap sticky left-[3.06rem] bg-gray-900 z-10 min-w-48">
                  <div class="flex flex-col">
                    <div class="font-medium">{driver.driverName}</div>
                    <div class="text-xs text-gray-500">{driver.teamName}</div>
                  </div>
                </td>
                {driver.raceResults.map((race, raceIndex) => {
                  const position = driverCumulativeStandings[raceIndex]?.[driver.driverAbbreviation];
                  return (
                    <td class="px-3 py-3 text-center whitespace-nowrap driver-race-cell">
                      <span class="driver-points-value">{race.points > 0 ? race.points : '-'}</span>
                      <span class="driver-position-value hidden text-xs text-gray-500 ml-1">
                        {position ? `(${position})` : ''}
                      </span>
                    </td>
                  );
                })}
                <td class="px-3 py-3 text-right whitespace-nowrap sticky right-0 bg-gray-900">
                  <div class="font-bold text-lg">{driver.totalPoints}</div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>

    <div class="bg-gray-900/50 border border-gray-800 rounded-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold">Constructor Standings - Points by Race</h2>
        <label class="flex items-center gap-3 cursor-pointer">
          <span class="text-sm text-gray-400">Show Positions</span>
          <input
            type="checkbox"
            id="showPositions"
            class="w-5 h-5 rounded bg-gray-800 border-gray-700 text-blue-600 focus:ring-blue-500 focus:ring-2"
          />
        </label>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm border-collapse">
          <thead class="bg-gray-800/50 border-b border-gray-700">
            <tr>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase sticky left-0 bg-gray-800 z-10 w-20">Pos</th>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase sticky left-[3.06rem] bg-gray-800 z-10 min-w-48">Team</th>
              {races.map((race) => (
                <th class="px-3 py-3 text-center text-xs font-medium text-gray-400 uppercase whitespace-nowrap">
                  <div class="flex flex-col items-center gap-1">
                    <span class="text-2xl">{getCountryFlag(race.country)}</span>
                    <span>{race.name}</span>
                  </div>
                </th>
              ))}
              <th class="px-3 py-3 text-right text-xs font-medium text-gray-400 uppercase sticky right-0 bg-gray-800">Total</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-800">
            {constructorRaceResults.map((team, index) => (
              <tr class="hover:bg-gray-800/30 transition-colors">
                <td class="px-3 py-3 whitespace-nowrap sticky left-0 bg-gray-900 z-10 w-20">
                  <div class="font-bold">{index + 1}</div>
                </td>
                <td class="px-3 py-3 whitespace-nowrap sticky left-[3.06rem] bg-gray-900 z-10 min-w-48">
                  <div class="flex items-center gap-3">
                    {team.teamLogo && (
                      <img src={team.teamLogo} alt={team.teamName} class="h-8 w-auto object-contain" />
                    )}
                    <div class="font-medium">{team.teamName}</div>
                  </div>
                </td>
                {team.raceResults.map((race, raceIndex) => {
                  const position = constructorCumulativeStandings[raceIndex]?.[team.teamName];
                  return (
                    <td class="px-3 py-3 text-center whitespace-nowrap constructor-race-cell">
                      <span class="constructor-points-value">{race.points > 0 ? race.points : '-'}</span>
                      <span class="constructor-position-value hidden text-xs text-gray-500 ml-1">
                        {position ? `(${position})` : ''}
                      </span>
                    </td>
                  );
                })}
                <td class="px-3 py-3 text-right whitespace-nowrap sticky right-0 bg-gray-900">
                  <div class="font-bold text-lg">{team.totalPoints}</div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Driver positions toggle
    const driverToggleCheckbox = document.getElementById('showDriverPositions') as HTMLInputElement;
    const driverPositionValues = document.querySelectorAll('.driver-position-value');

    if (driverToggleCheckbox) {
      driverToggleCheckbox.addEventListener('change', (e) => {
        const isChecked = (e.target as HTMLInputElement).checked;

        driverPositionValues.forEach((positionValue) => {
          if (isChecked) {
            positionValue.classList.remove('hidden');
          } else {
            positionValue.classList.add('hidden');
          }
        });
      });
    }

    // Constructor positions toggle
    const constructorToggleCheckbox = document.getElementById('showPositions') as HTMLInputElement;
    const constructorPositionValues = document.querySelectorAll('.constructor-position-value');

    if (constructorToggleCheckbox) {
      constructorToggleCheckbox.addEventListener('change', (e) => {
        const isChecked = (e.target as HTMLInputElement).checked;

        constructorPositionValues.forEach((positionValue) => {
          if (isChecked) {
            positionValue.classList.remove('hidden');
          } else {
            positionValue.classList.add('hidden');
          }
        });
      });
    }
  });
</script>
