---
import Layout from '../layouts/Layout.astro';
import { getRaceResults } from '../lib/api';

// Get the year and round from URL params
const url = new URL(Astro.request.url);
const yearParam = url.searchParams.get('year');
const roundParam = url.searchParams.get('round');

if (!yearParam || !roundParam) {
  return Astro.redirect('/schedule');
}

const year = parseInt(yearParam);
const round = parseInt(roundParam);

const data = await getRaceResults(year, round);
const { race, results } = data;
---

<Layout title={`${race.eventName} ${year} Results`}>
  <div class="max-w-7xl mx-auto px-4 py-12">
    <div class="mb-8">
      <a href={`/schedule?year=${year}`} class="text-red-500 hover:text-red-400 mb-4 inline-block">
        ‚Üê Back to Schedule
      </a>
      <h1 class="text-4xl font-bold">{race.eventName}</h1>
      <p class="text-gray-400 text-lg mt-2">{race.location}, {race.country} ‚Ä¢ {new Date(race.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
      <p class="text-gray-500">Round {race.roundNumber} of {year}</p>
    </div>

    <div class="bg-gray-900/50 border border-gray-800 rounded-lg overflow-hidden">
      <table class="w-full">
        <thead class="bg-gray-800/50 border-b border-gray-700">
          <tr>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase">Pos</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase">Driver</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase">Team</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase">Grid</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase">Points</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase">Status</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-800">
          {results.map((result) => {
            let positionColor = '';
            if (result.position === 1) positionColor = 'text-yellow-400';
            else if (result.position === 2) positionColor = 'text-gray-300';
            else if (result.position === 3) positionColor = 'text-orange-400';

            const statusColor = result.status === 'Finished' ? 'text-green-400' : 'text-red-400';

            // Calculate position change (grid position - final position)
            // Positive means they moved up, negative means they moved down
            const positionChange = result.grid_position && result.position
              ? result.grid_position - result.position
              : null;

            return (
              <tr class="hover:bg-gray-800/50">
                <td class={`px-6 py-4 font-bold ${positionColor}`}>
                  <div class="flex items-center gap-2">
                    <div class="flex items-center gap-1">
                      {result.position === 1 && <span class="text-2xl">üèÜ</span>}
                      {result.position === 2 && <span class="text-2xl">ü•à</span>}
                      {result.position === 3 && <span class="text-2xl">ü•â</span>}
                      {result.position > 3 && <span>{result.position}</span>}
                      {!result.position && <span>-</span>}
                    </div>
                    {positionChange !== null && positionChange !== 0 && (
                      <div class={`flex items-center text-xs ${positionChange > 0 ? 'text-green-400' : 'text-red-400'}`}>
                        {positionChange > 0 ? '‚Üë' : '‚Üì'}
                        <span class="ml-0.5">{Math.abs(positionChange)}</span>
                      </div>
                    )}
                  </div>
                </td>
                <td class="px-6 py-4">
                  <div class="flex items-center gap-2">
                    {result.driver_number && (
                      <span class="text-gray-500 font-medium">{result.driver_number}</span>
                    )}
                    <span class="font-medium">{result.driver_name}</span>
                    {result.fastest_lap === 1 && (
                      <span class="px-2 py-0.5 bg-purple-500/20 text-purple-400 text-xs rounded font-medium">
                        FL
                      </span>
                    )}
                  </div>
                </td>
                <td class="px-6 py-4">
                  {result.team_logo && (
                    <div class="flex items-center gap-2">
                      <img
                        src={result.team_logo}
                        alt={result.team_name}
                        class="h-5 w-auto object-contain"
                      />
                      <span class="text-gray-400 text-sm">{result.team_name}</span>
                    </div>
                  )}
                  {!result.team_logo && (
                    <span class="text-gray-400 text-sm">{result.team_name || '-'}</span>
                  )}
                </td>
                <td class="px-6 py-4 text-gray-400">
                  {result.grid_position || '-'}
                </td>
                <td class="px-6 py-4 text-gray-400">
                  {result.points !== null && result.points !== undefined ? result.points : '-'}
                </td>
                <td class="px-6 py-4">
                  <span class={result.status ? statusColor : 'text-gray-500'}>
                    {result.status || (result.position ? 'Finished' : '-')}
                  </span>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>

    {results.length === 0 && (
      <div class="text-center py-12 text-gray-500">
        No race results available for this event.
      </div>
    )}
  </div>
</Layout>
